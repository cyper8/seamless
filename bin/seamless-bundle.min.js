var Seamless=function(t){"use strict";function e(){function t(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function e(e,n,s,r,i,o){return t(function(t,e){return t<<e|t>>>32-e}(t(t(n,e),t(r,o)),i),s)}function n(t,n,s,r,i,o,c){return e(n&s|~n&r,t,n,i,o,c)}function s(t,n,s,r,i,o,c){return e(n&r|s&~r,t,n,i,o,c)}function r(t,n,s,r,i,o,c){return e(n^s^r,t,n,i,o,c)}function i(t,n,s,r,i,o,c){return e(s^(n|~r),t,n,i,o,c)}function o(e,o){e[o>>5]|=128<<o%32,e[14+(o+64>>>9<<4)]=o;var c,a,h,l,u,_=1732584193,d=-271733879,f=-1732584194,m=271733878;for(c=0;c<e.length;c+=16)a=_,h=d,l=f,u=m,_=n(_,d,f,m,e[c],7,-680876936),m=n(m,_,d,f,e[c+1],12,-389564586),f=n(f,m,_,d,e[c+2],17,606105819),d=n(d,f,m,_,e[c+3],22,-1044525330),_=n(_,d,f,m,e[c+4],7,-176418897),m=n(m,_,d,f,e[c+5],12,1200080426),f=n(f,m,_,d,e[c+6],17,-1473231341),d=n(d,f,m,_,e[c+7],22,-45705983),_=n(_,d,f,m,e[c+8],7,1770035416),m=n(m,_,d,f,e[c+9],12,-1958414417),f=n(f,m,_,d,e[c+10],17,-42063),d=n(d,f,m,_,e[c+11],22,-1990404162),_=n(_,d,f,m,e[c+12],7,1804603682),m=n(m,_,d,f,e[c+13],12,-40341101),f=n(f,m,_,d,e[c+14],17,-1502002290),_=s(_,d=n(d,f,m,_,e[c+15],22,1236535329),f,m,e[c+1],5,-165796510),m=s(m,_,d,f,e[c+6],9,-1069501632),f=s(f,m,_,d,e[c+11],14,643717713),d=s(d,f,m,_,e[c],20,-373897302),_=s(_,d,f,m,e[c+5],5,-701558691),m=s(m,_,d,f,e[c+10],9,38016083),f=s(f,m,_,d,e[c+15],14,-660478335),d=s(d,f,m,_,e[c+4],20,-405537848),_=s(_,d,f,m,e[c+9],5,568446438),m=s(m,_,d,f,e[c+14],9,-1019803690),f=s(f,m,_,d,e[c+3],14,-187363961),d=s(d,f,m,_,e[c+8],20,1163531501),_=s(_,d,f,m,e[c+13],5,-1444681467),m=s(m,_,d,f,e[c+2],9,-51403784),f=s(f,m,_,d,e[c+7],14,1735328473),_=r(_,d=s(d,f,m,_,e[c+12],20,-1926607734),f,m,e[c+5],4,-378558),m=r(m,_,d,f,e[c+8],11,-2022574463),f=r(f,m,_,d,e[c+11],16,1839030562),d=r(d,f,m,_,e[c+14],23,-35309556),_=r(_,d,f,m,e[c+1],4,-1530992060),m=r(m,_,d,f,e[c+4],11,1272893353),f=r(f,m,_,d,e[c+7],16,-155497632),d=r(d,f,m,_,e[c+10],23,-1094730640),_=r(_,d,f,m,e[c+13],4,681279174),m=r(m,_,d,f,e[c],11,-358537222),f=r(f,m,_,d,e[c+3],16,-722521979),d=r(d,f,m,_,e[c+6],23,76029189),_=r(_,d,f,m,e[c+9],4,-640364487),m=r(m,_,d,f,e[c+12],11,-421815835),f=r(f,m,_,d,e[c+15],16,530742520),_=i(_,d=r(d,f,m,_,e[c+2],23,-995338651),f,m,e[c],6,-198630844),m=i(m,_,d,f,e[c+7],10,1126891415),f=i(f,m,_,d,e[c+14],15,-1416354905),d=i(d,f,m,_,e[c+5],21,-57434055),_=i(_,d,f,m,e[c+12],6,1700485571),m=i(m,_,d,f,e[c+3],10,-1894986606),f=i(f,m,_,d,e[c+10],15,-1051523),d=i(d,f,m,_,e[c+1],21,-2054922799),_=i(_,d,f,m,e[c+8],6,1873313359),m=i(m,_,d,f,e[c+15],10,-30611744),f=i(f,m,_,d,e[c+6],15,-1560198380),d=i(d,f,m,_,e[c+13],21,1309151649),_=i(_,d,f,m,e[c+4],6,-145523070),m=i(m,_,d,f,e[c+11],10,-1120210379),f=i(f,m,_,d,e[c+2],15,718787259),d=i(d,f,m,_,e[c+9],21,-343485551),_=t(_,a),d=t(d,h),f=t(f,l),m=t(m,u);return[_,d,f,m]}function c(t){var e,n="";for(e=0;e<32*t.length;e+=8)n+=String.fromCharCode(t[e>>5]>>>e%32&255);return n}function a(t){var e,n=[];for(n[(t.length>>2)-1]=void 0,e=0;e<n.length;e+=1)n[e]=0;for(e=0;e<8*t.length;e+=8)n[e>>5]|=(255&t.charCodeAt(e/8))<<e%32;return n}function h(t){var e,n,s="0123456789abcdef",r="";for(n=0;n<t.length;n+=1)e=t.charCodeAt(n),r+=s.charAt(e>>>4&15)+s.charAt(15&e);return r}function l(t){return unescape(encodeURIComponent(t))}function u(t){return function(t){return c(o(a(t),8*t.length))}(l(t))}function _(t,e){return function(t,e){var n,s,r=a(t),i=[],h=[];for(i[15]=h[15]=void 0,r.length>16&&(r=o(r,8*t.length)),n=0;n<16;n+=1)i[n]=909522486^r[n],h[n]=1549556828^r[n];return s=o(i.concat(a(e)),512+8*e.length),c(o(h.concat(s),640))}(l(t),l(e))}return function(t,e,n){return e?n?_(e,t):function(t,e){return h(_(t,e))}(e,t):n?u(t):function(t){return h(u(t))}(t)}}function n(t){let e,n,s,r=t.split("/");if(-1!==r[0].search(/:$/)?e=r.shift():(e=window.location.protocol,""===r[0]&&r.shift()),""===r[0]&&(r.shift(),n=r.shift()),n&&""!==n||(n=window.location.host),s=encodeURI(`${e}//${n}/${r.join("/")}`),new URL(s))return s}const s=e(),r=function(t){try{var e=window[t],n="__storage_test__";return e.setItem(n,n),e.removeItem(n),!0}catch(t){return!1}}("localStorage")?window.localStorage:Object.defineProperties({},{setItem:{value:function(t,e){var n=new StorageEvent("storage",{key:t,oldValue:this[t],newValue:e,storageArea:this});return this[t]=e,(window||self).dispatchEvent(n),e}},getItem:{value:function(t){return this[t]||null}},removeItem:{value:function(t){let e=this[t];return delete this[t],window.dispatchEvent(new StorageEvent("storage",{key:t,oldValue:e,newValue:void 0,storageArea:this})),this}},key:{value:function(t){var e,n=0;for(e in this){if(n==t)return this[e];n++}}},clear:{value:function(){var t;for(t in this)this.removeItem(t);return this}},length:{get:function(){var t,e=0;for(t in this)e++;return e}}});class i{constructor(t){this.hash=s(t),this.__init()}__init(){return this.datahash=Promise.resolve(r.getItem(this.hash)),(this.cache=this.__retrieve()).then((()=>this))}read(){return Promise.race([this.cache,this.__retrieve()])}__retrieve(){return this.datahash.then((t=>r.getItem(t)||"")).then((t=>this.__cache(t)))}__cache(t){let e;if(""!==t)try{e=JSON.parse(t)}catch(t){console.error(t)}return this.cache=e}write(t){let e;try{e=JSON.stringify(t)}catch(t){console.error(t),e=""}let n=s(e);return this.datahash.then((s=>(n!==s&&(this.datahash=Promise.resolve(r.removeItem(s)).then((()=>(this.__cache(e),r.setItem(n,e),r.setItem(this.hash,n),n)))),t)))}get data(){return this.cache instanceof Object&&!(this.cache instanceof Promise)?this.cache:void 0}set data(t){this.write(t)}clear(){return this.datahash.then((t=>{r.removeItem(t),r.removeItem(this.hash)})).then((()=>this.__init()))}}class o{constructor(t,e){this.__reconnectCount=0,this.__errorCount=0,this.__url=t,this.__receive=e,this.__connection=this.__connect()}get transmitter(){return this.__connection.then((()=>this.__send.bind(this)))}__send(t){this.__connection.then((function(e){e.send(t)}))}__connect(){return new Promise((t=>{this.socket=new WebSocket(this.__url),this.__timer=window.setTimeout(this.socket.close,9e3),this.socket.onclose=()=>{if(clearTimeout(this.__timer),this.__reconnectCount++,!(this.__reconnectCount<5))throw new Error(this.__url+" does not answer");this.__connection=this.__connect()},this.socket.onerror=t=>{console.error(t),this.__errorCount++,this.__errorCount>10&&(this.__errorCount=0,this.socket.close())},this.socket.onopen=()=>{clearTimeout(this.__timer),this.__reconnectCount=0,this.__errorCount=0,t(this.socket)},this.socket.onmessage=t=>{let e;try{e=JSON.parse(t.data)}catch(t){throw t}e&&this.__receive(e)}}))}close(){this.socket.onclose=void 0,this.socket.close()}}class c{constructor(t,e){this.__reconnectCount=0,this.__url=t.search(/^https?:\/\//i)<0?t.replace(/^[^:]+:/i,"http:"):t,this.__receiver=e,this.__init().then((()=>this.__poll()))}__request(t,e){let n;console.log(t);let s={method:e&&""!=e?"POST":"GET",headers:{Accept:"application/json"}};return"POST"===s.method&&(s.body=e,s.headers["Content-Type"]="application/json"),n=fetch&&AbortController?function(t,e){let n=new AbortController,s=n.signal;return e.signal=s,{request:Promise.race([fetch(t,e).then((t=>{if(200===t.status)return t.json();throw new Error(t.status.toString())})),new Promise(((t,e)=>setTimeout((()=>{n.abort(),e(new Error("Fetch timeout reached. Request aborted."))}),3e4)))]),abort(){n.abort()}}}(t,s):function(t,e){let n,s=e.body;return{request:new Promise((function(r,i){n=new XMLHttpRequest;const o=function(){i(new Error("Request cancelled"))}.bind(n),c=function(){i(new Error("Connection timeout reached")),this.readyState>0&&this.readyState<4&&this.abort()}.bind(n),a=function(t){i(t),this.readyState>0&&this.readyState<4&&this.abort()}.bind(n);n.timeout=3e4,n.addEventListener("readystatechange",(function(){4==this.readyState&&200==this.status&&r(this.response)})),n.addEventListener("error",a),n.addEventListener("timeout",c),n.addEventListener("abort",o),n.responseType="json",n.open(e.method,t,!0);for(let t in e.headers)n.setRequestHeader(t,e.headers[t]);n.send(s||"")})),abort(){n.abort()}}}(t,s),this.request=n,n.request.then((t=>{this.__receiver(t)}))}__Post(t){return this.__request(this.__url,"string"!=typeof t?JSON.stringify(t):t)}__init(){let t,e;return console.log("initializing"),this.transmitter=new Promise(((n,s)=>{[t,e]=[n,s]})),this.__request(this.__url+"?nopoll=true","").then((()=>{t(this.__Post.bind(this)),console.log("initialized")}),(t=>{console.error("Connection Initialization failed:",t),e(t)}))}__poll(){return console.log("polling"),this.__request(this.__url,"").then((()=>{this.__timer=window.setTimeout(this.__poll.bind(this),1e3)})).catch((t=>{console.error("Connection polling failure: ",t),this.__reconnectCount>5?(window.clearTimeout(this.__timer),this.__reconnectCount=0,console.error("Poller connection lost. Reconnection constantly failing. Try reloading page."),this.transmitter=Promise.reject(t)):(console.error("Reconnecting attempt "+this.__reconnectCount++),this.__timer=window.setTimeout(this.__poll.bind(this),1e3))}))}close(){this.request.abort()}}class a{constructor(t,e){t.search(/^wss?:\/\//i)>=0&&WebSocket?this.__backend=new o(t,e):this.__backend=new c(t.replace(/^ws/,"http"),e)}get egress(){return this.__backend.transmitter}close(){this.__backend.close()}}function h(t){if(!t)throw new Error("Wrong argument");var e=t.match(/^[a-z][a-z0-9-]*/i),n=t.match(/\.([a-z][a-z0-9_-]*)/gi)||[],s=t.match(/\#([a-z][a-z0-9_-]*)/i)||[],r=document.createElement(e[0]);return r.className=(n.length>0?n.join(" "):"").replace(/\./g,""),r.id=s.length>0?s[0].replace(/\#/,""):"",r}function l(t,e){for(var n=[],s=0;s<e.length;s++){var r=e[s].querySelectorAll("#"+t);0==r.length&&(r=[]).push(e[s].appendChild(h("div#"+t)));for(var i=0;i<r.length;i++)n.push(r[i])}return n}function u(t){var e;for(e in t)if("_id"==e||"boolean"==typeof t[e])this.setAttribute(e,t[e]);else switch(typeof t[e]){case"number":case"string":l(e,[this]).forEach((function(n){var s,r,i;n instanceof HTMLInputElement?(n.value=t[e],n.onchange||(n.onchange=(s=function(){t[this.id]=this.value,this.dispatchEvent(new CustomEvent("seamlessdatachange",{bubbles:!0}))},r=1e3,function(){var t=this,e=arguments;i&&(clearTimeout(i),i=void 0),i=setTimeout((function(){clearTimeout(i),i=void 0,(s||function(){}).apply(t,e)}),r||0)}))):n.innerText=t[e]}));break;case"object":l(e,[this]).forEach((function(n){u.apply(n,t[e])}))}}class _{constructor(t,e,n){let s;function r(t){t.stopPropagation(),e(s)}let i={value:Function,enumerable:!0,configurable:!0},o={value:function(){void 0!==this.seamless&&(delete this.seamless,this.removeEventListener&&this.removeEventListener("seamlessdatachange",r)),this.status&&delete this.status}.bind(this),enumerable:!0,configurable:!0},c={get:()=>s,set(t){e(t)},enumerable:!0,configurable:!0};t instanceof HTMLElement?(t.addEventListener("seamlessdatachange",r),t.dataset.sync&&"function"==typeof window[t.dataset.sync]?i.value=window[t.dataset.sync].bind(t):i.value=u.bind(t)):"function"==typeof t?i.value=t.bind(t):"object"==typeof t&&(i.value=!1);let a={seamless:i,deseamless:o,status:c};Object.defineProperties(this,a),Promise.resolve(n).then((t=>{s=t,this.seamless&&this.seamless(s,e)}))}}class d{constructor(t){this.clients=[],this.to(t)}__ToDOM(t){this.clients.forEach((function(e){e.seamless?e.seamless(t):e.status=t}))}__receiver(t){this.__buffer.write(t).then((t=>this.__ToDOM(t)))}__transmit(t){return Promise.all([this.__transmitter,this.__buffer.write(t)]).then((([t,e])=>t(e)))}get __transmitter(){return this.__channel.egress}to(t){return this.__channel&&this.close(),this.url=n(t),this.__buffer=new i(this.url),this.__channel=new a(this.url,this.__receiver.bind(this)),this}get established(){return new Promise((t=>{this.__transmitter.then((()=>{t(this)}))}))}close(){return this.__channel.close(),this}bindClients(t){return this.clients=t.map((t=>new _(t,this.__transmit.bind(this),this.__buffer.cache))),this}unbindClients(t){return(t||this.clients).forEach((t=>{let e=this.clients.indexOf(t);if(e>=0){let t=this.clients.splice(e,1)[0];t.deseamless&&t.deseamless()}})),this}}const f=e(),m={connections:new Map,compile(t){let e=t.querySelectorAll("*[data-seamless]"),n=[];for(let t=0;t<e.length;t++){let s=e[t];n.push(m.connect(s.dataset.seamless).bindClients([s]).established)}return Promise.all(n)},getConnection(t){let e=n(t);return m.connections.get(f(e))},connect(t){let e=m.getConnection(t);return e||(e=new d(t),m.connections.set(f(e.url),e)),e},disconnect(t){let e=m.getConnection(t);return e.unbindClients(),e.close(),m.connections.delete(f(e.url))},shutdown(){let t;for(t in m.connections.keys)m.disconnect(t)}};return t.Seamless=m,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
