var Seamless=function(a){"use strict";function b(){function b(a,b){var c=(65535&a)+(65535&b);return(a>>16)+(b>>16)+(c>>16)<<16|65535&c}function j(a,b){return a<<b|a>>>32-b}function k(a,c,d,e,f,g){return b(j(b(b(c,a),b(e,g)),f),d)}function n(a,b,c,d,e,f,g){return k(b&c|~b&d,a,b,e,f,g)}function i(a,b,c,d,e,f,g){return k(b&d|c&~d,a,b,e,f,g)}function q(a,b,c,d,e,f,g){return k(b^c^d,a,b,e,f,g)}function o(a,b,c,d,e,f,g){return k(c^(b|~d),a,b,e,f,g)}function u(g,e){g[e>>5]|=128<<e%32,g[(e+64>>>9<<4)+14]=e;var j,k,m,s,t,u=1732584193,w=-271733879,x=-1732584194,y=271733878;for(j=0;j<g.length;j+=16)k=u,m=w,s=x,t=y,u=n(u,w,x,y,g[j],7,-680876936),y=n(y,u,w,x,g[j+1],12,-389564586),x=n(x,y,u,w,g[j+2],17,606105819),w=n(w,x,y,u,g[j+3],22,-1044525330),u=n(u,w,x,y,g[j+4],7,-176418897),y=n(y,u,w,x,g[j+5],12,1200080426),x=n(x,y,u,w,g[j+6],17,-1473231341),w=n(w,x,y,u,g[j+7],22,-45705983),u=n(u,w,x,y,g[j+8],7,1770035416),y=n(y,u,w,x,g[j+9],12,-1958414417),x=n(x,y,u,w,g[j+10],17,-42063),w=n(w,x,y,u,g[j+11],22,-1990404162),u=n(u,w,x,y,g[j+12],7,1804603682),y=n(y,u,w,x,g[j+13],12,-40341101),x=n(x,y,u,w,g[j+14],17,-1502002290),w=n(w,x,y,u,g[j+15],22,1236535329),u=i(u,w,x,y,g[j+1],5,-165796510),y=i(y,u,w,x,g[j+6],9,-1069501632),x=i(x,y,u,w,g[j+11],14,643717713),w=i(w,x,y,u,g[j],20,-373897302),u=i(u,w,x,y,g[j+5],5,-701558691),y=i(y,u,w,x,g[j+10],9,38016083),x=i(x,y,u,w,g[j+15],14,-660478335),w=i(w,x,y,u,g[j+4],20,-405537848),u=i(u,w,x,y,g[j+9],5,568446438),y=i(y,u,w,x,g[j+14],9,-1019803690),x=i(x,y,u,w,g[j+3],14,-187363961),w=i(w,x,y,u,g[j+8],20,1163531501),u=i(u,w,x,y,g[j+13],5,-1444681467),y=i(y,u,w,x,g[j+2],9,-51403784),x=i(x,y,u,w,g[j+7],14,1735328473),w=i(w,x,y,u,g[j+12],20,-1926607734),u=q(u,w,x,y,g[j+5],4,-378558),y=q(y,u,w,x,g[j+8],11,-2022574463),x=q(x,y,u,w,g[j+11],16,1839030562),w=q(w,x,y,u,g[j+14],23,-35309556),u=q(u,w,x,y,g[j+1],4,-1530992060),y=q(y,u,w,x,g[j+4],11,1272893353),x=q(x,y,u,w,g[j+7],16,-155497632),w=q(w,x,y,u,g[j+10],23,-1094730640),u=q(u,w,x,y,g[j+13],4,681279174),y=q(y,u,w,x,g[j],11,-358537222),x=q(x,y,u,w,g[j+3],16,-722521979),w=q(w,x,y,u,g[j+6],23,76029189),u=q(u,w,x,y,g[j+9],4,-640364487),y=q(y,u,w,x,g[j+12],11,-421815835),x=q(x,y,u,w,g[j+15],16,530742520),w=q(w,x,y,u,g[j+2],23,-995338651),u=o(u,w,x,y,g[j],6,-198630844),y=o(y,u,w,x,g[j+7],10,1126891415),x=o(x,y,u,w,g[j+14],15,-1416354905),w=o(w,x,y,u,g[j+5],21,-57434055),u=o(u,w,x,y,g[j+12],6,1700485571),y=o(y,u,w,x,g[j+3],10,-1894986606),x=o(x,y,u,w,g[j+10],15,-1051523),w=o(w,x,y,u,g[j+1],21,-2054922799),u=o(u,w,x,y,g[j+8],6,1873313359),y=o(y,u,w,x,g[j+15],10,-30611744),x=o(x,y,u,w,g[j+6],15,-1560198380),w=o(w,x,y,u,g[j+13],21,1309151649),u=o(u,w,x,y,g[j+4],6,-145523070),y=o(y,u,w,x,g[j+11],10,-1120210379),x=o(x,y,u,w,g[j+2],15,718787259),w=o(w,x,y,u,g[j+9],21,-343485551),u=b(u,k),w=b(w,m),x=b(x,s),y=b(y,t);return[u,w,x,y]}function a(a){var c,b=String.fromCharCode,d="";for(c=0;c<32*a.length;c+=8)d+=b(255&a[c>>5]>>>c%32);return d}function f(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function l(b){return a(u(f(b),8*b.length))}function c(b,c){var d,e,g=f(b),h=[],i=[];for(h[15]=i[15]=void 0,16<g.length&&(g=u(g,8*b.length)),d=0;16>d;d+=1)h[d]=909522486^g[d],i[d]=1549556828^g[d];return e=u(h.concat(f(c)),512+8*c.length),a(u(i.concat(e),640))}function h(a){var b,c,d="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),d+="0123456789abcdef".charAt(15&b>>>4)+"0123456789abcdef".charAt(15&b);return d}function p(a){return unescape(encodeURIComponent(a))}function d(a){return l(p(a))}function r(a){return h(d(a))}function m(a,b){return c(p(a),p(b))}function g(a,b){return h(m(a,b))}return function(a,b,c){return b?c?m(b,a):g(b,a):c?d(a):r(a)}}function c(a){let b,c,d,e=a.split("/");if(-1===e[0].search(/:$/)?(b=window.location.protocol,""===e[0]&&e.shift()):b=e.shift(),""===e[0]&&(e.shift(),c=e.shift()),c&&""!==c||(c=window.location.host),d=encodeURI(`${b}//${c}/${e.join("/")}`),new URL(d))return d}/*  global localStorage, CustomEvent  */function d(a,b){let c=new AbortController,d=c.signal;return b.signal=d,{request:Promise.race([fetch(a,b).then(a=>{if(200===a.status)return a.json();throw new Error(a.status.toString())}),new Promise((a,b)=>setTimeout(()=>{c.abort(),b(new Error("Fetch timeout reached. Request aborted."))},3e4))]),abort(){c.abort()}}}function e(a,b){let c,d=b.body;return{request:new Promise(function(e,f){c=new XMLHttpRequest;const g=function(){f(new Error("Request cancelled"))}.bind(c),i=function(){f(new Error("Connection timeout reached")),0<this.readyState&&4>this.readyState&&this.abort()}.bind(c),j=function(a){f(a),0<this.readyState&&4>this.readyState&&this.abort()}.bind(c);for(let d in c.timeout=3e4,c.addEventListener("readystatechange",function(){4==this.readyState&&200==this.status&&e(this.response)}),c.addEventListener("error",j),c.addEventListener("timeout",i),c.addEventListener("abort",g),c.responseType="json",c.open(b.method,a,!0),b.headers)c.setRequestHeader(d,b.headers[d]);c.send(d||"")}),abort(){c.abort()}}}function f(a){if(!a)throw new Error("Wrong argument");var b=a.match(/^[a-z][a-z0-9-]*/i),c=a.match(/\.([a-z][a-z0-9_-]*)/ig)||[],d=a.match(/\#([a-z][a-z0-9_-]*)/i)||[],e=document.createElement(b[0]);return e.className=(0<c.length?c.join(" "):"").replace(/\./g,""),e.id=0<d.length?d[0].replace(/\#/,""):"",e}function g(a,b){var c;return function(){var d=this,e=arguments;c&&(clearTimeout(c),c=void 0),c=setTimeout(function(){clearTimeout(c),c=void 0,(a||function(){}).apply(d,e)},b||0)}}function h(a,b){for(var c,d=[],g=0;g<b.length;g++){c=b[g].querySelectorAll("#"+a),0==c.length&&(c=[]).push(b[g].appendChild(f("div#"+a)));for(var h=0;h<c.length;h++)d.push(c[h])}return d}function i(a){for(var b in a)if("_id"==b||"boolean"==typeof a[b])this.setAttribute(b,a[b]);else switch(typeof a[b]){case"number":case"string":h(b,[this]).forEach(function(c){c instanceof HTMLInputElement?(c.value=a[b],!c.onchange&&(c.onchange=g(function(){a[this.id]=this.value,this.dispatchEvent(new CustomEvent("seamlessdatachange",{bubbles:!0}))},1e3))):c.innerText=a[b]});break;case"object":h(b,[this]).forEach(function(c){i.apply(c,a[b])});}}const j=b(),k=function(){return function(a){try{var b=window[a];return b.setItem("__storage_test__","__storage_test__"),b.removeItem("__storage_test__"),!0}catch(a){return!1}}("localStorage")?window.localStorage:Object.defineProperties({},{setItem:{value:function(a,b){var c=new StorageEvent("storage",{key:a,oldValue:this[a],newValue:b,storageArea:this});return this[a]=b,(window||self).dispatchEvent(c),b;// incompatible with Storage interface - it should return void
}},getItem:{value:function(a){return this[a]||null}},removeItem:{value:function(a){let b=this[a];return delete this[a],window.dispatchEvent(new StorageEvent("storage",{key:a,oldValue:b,newValue:void 0,storageArea:this})),this}},key:{value:function(a){var b,d=0;for(b in this){if(d==a)return this[b];d++}}},clear:{value:function(){for(var a in this)this.removeItem(a);return this}},length:{get:function(){var a,b=0;for(a in this)b++;return b}}})}();class l{constructor(a){this.hash=j(a),this.__init()}__init(){return this.datahash=Promise.resolve(k.getItem(this.hash)),(this.cache=this.__retrieve()).then(()=>this)}read(){return Promise.race([this.cache,this.__retrieve()])}__retrieve(){return this.datahash.then(a=>k.getItem(a)||"").then(a=>this.__cache(a))}__cache(a){let b;if(""!==a)try{b=JSON.parse(a)}catch(a){console.error(a)}return this.cache=b}write(a){let b;try{b=JSON.stringify(a)}catch(a){console.error(a),b=""}let c=j(b);return this.datahash.then(d=>(c!==d&&(this.datahash=Promise.resolve(k.removeItem(d)).then(()=>(this.__cache(b),k.setItem(c,b),k.setItem(this.hash,c),c))),a))}get data(){return this.cache instanceof Object&&!(this.cache instanceof Promise)?this.cache:void 0}set data(a){this.write(a)}clear(){return this.datahash.then(a=>{k.removeItem(a),k.removeItem(this.hash)}).then(()=>this.__init())}}class m{constructor(a,b){this.__reconnectCount=0,this.__errorCount=0,this.__url=a,this.__receive=b,this.__connection=this.__connect()}get transmitter(){return this.__connection.then(()=>this.__send.bind(this))}__send(a){this.__connection.then(function(b){b.send(a)})}__connect(){return new Promise(a=>{this.socket=new WebSocket(this.__url),this.__timer=window.setTimeout(this.socket.close,9e3),this.socket.onclose=()=>{if(clearTimeout(this.__timer),this.__reconnectCount++,5>this.__reconnectCount)this.__connection=this.__connect();else throw new Error(this.__url+" does not answer")},this.socket.onerror=a=>{console.error(a),this.__errorCount++,10<this.__errorCount&&(this.__errorCount=0,this.socket.close())},this.socket.onopen=()=>{clearTimeout(this.__timer),this.__reconnectCount=0,this.__errorCount=0,a(this.socket)},this.socket.onmessage=a=>{let b;try{b=JSON.parse(a.data)}catch(a){throw a}b&&this.__receive(b)}})}close(){this.socket.onclose=void 0,this.socket.close()}}class n{constructor(a,b){this.__reconnectCount=0,this.__url=0>a.search(/^https?:\/\//i)?a.replace(/^[^:]+:/i,"http:"):a,this.__receiver=b,this.__init().then(()=>this.__poll())}__request(a,b){console.log(a);let c,f={method:b&&""!=b?"POST":"GET",headers:{Accept:"application/json"}};return"POST"===f.method&&(f.body=b,f.headers["Content-Type"]="application/json"),c=fetch&&AbortController?d(a,f):e(a,f),this.request=c,c.request.then(a=>{this.__receiver(a)})}__Post(a){return this.__request(this.__url,"string"==typeof a?a:JSON.stringify(a))}__init(){let a,b;return console.log("initializing"),this.transmitter=new Promise((c,d)=>{[a,b]=[c,d]}),this.__request(this.__url+"?nopoll=true","").then(()=>{a(this.__Post.bind(this)),console.log("initialized")},a=>{console.error(`Connection Initialization failed:`,a),b(a)})}__poll(){return console.log("polling"),this.__request(this.__url,"").then(()=>{this.__timer=window.setTimeout(this.__poll.bind(this),1e3)}).catch(a=>{console.error(`Connection polling failure: `,a),5<this.__reconnectCount?(window.clearTimeout(this.__timer),this.__reconnectCount=0,console.error("Poller connection lost. Reconnection constantly failing. Try reloading page."),this.transmitter=Promise.reject(a)):(console.error("Reconnecting attempt "+this.__reconnectCount++),this.__timer=window.setTimeout(this.__poll.bind(this),1e3))})}close(){this.request.abort()}}class o{get egress(){return this.__backend.transmitter}close(){this.__backend.close()}constructor(a,b){this.__backend=0<=a.search(/^wss?:\/\//i)&&WebSocket?new m(a,b):new n(a.replace(/^ws/,"http"),b)}}class p{constructor(a,b,c){function d(a){a.stopPropagation(),b(e)}let e,f={value:Function,enumerable:!0,configurable:!0},g={value:function(){void 0!==this.seamless&&(delete this.seamless,this.removeEventListener&&this.removeEventListener("seamlessdatachange",d)),this.status&&delete this.status}.bind(this),enumerable:!0,configurable:!0},h={get(){return e},set(a){b(a)},enumerable:!0,configurable:!0};a instanceof HTMLElement?(a.addEventListener("seamlessdatachange",d),f.value=a.dataset.sync&&"function"==typeof window[a.dataset.sync]?window[a.dataset.sync].bind(a):i.bind(a)):"function"==typeof a?f.value=a.bind(a):"object"==typeof a&&(f.value=!1);Object.defineProperties(this,{seamless:f,deseamless:g,status:h}),Promise.resolve(c).then(a=>{e=a,this.seamless&&this.seamless(e,b)})}}class q{constructor(a){this.clients=[],this.to(a)}__ToDOM(a){this.clients.forEach(function(b){b.seamless?b.seamless(a):b.status=a})}__receiver(a){this.__buffer.write(a).then(a=>this.__ToDOM(a))}__transmit(a){return Promise.all([this.__transmitter,this.__buffer.write(a)]).then(([a,b])=>a(b))}get __transmitter(){return this.__channel.egress}to(a){return this.__channel&&this.close(),this.url=c(a),this.__buffer=new l(this.url),this.__channel=new o(this.url,this.__receiver.bind(this)),this}get established(){return new Promise(a=>{this.__transmitter.then(()=>{a(this)})})}close(){return this.__channel.close(),this}bindClients(a){return this.clients=a.map(a=>new p(a,this.__transmit.bind(this),this.__buffer.cache)),this}unbindClients(a){let b=a||this.clients;return b.forEach(a=>{let b=this.clients.indexOf(a);if(0<=b){let a=this.clients.splice(b,1)[0];a.deseamless&&a.deseamless()}}),this}}const r=b(),s={connections:new Map,compile(a){let b=a.querySelectorAll("*[data-seamless]"),c=[];for(let d,e=0;e<b.length;e++)d=b[e],c.push(s.connect(d.dataset.seamless).bindClients([d]).established);return Promise.all(c)},getConnection(a){let b=c(a);return s.connections.get(r(b))},connect(a){let b=s.getConnection(a);return b||(b=new q(a),s.connections.set(r(b.url),b)),b},disconnect(a){let b=s.getConnection(a);return b.unbindClients(),b.close(),s.connections.delete(r(b.url))},shutdown(){for(var a in s.connections.keys)s.disconnect(a)}};return a.Seamless=s,a}({});
